<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Civic - Report Issues</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
          'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
          sans-serif;
        background-color: #000000;
        color: #ffffff;
        line-height: 1.6;
      }

      /* Navigation */
      nav {
        position: fixed;
        top: 0;
        left: 0;
        padding: 24px 32px;
        z-index: 1000;
      }

      .logo {
        width: auto;
        height: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.3s ease;
        text-decoration: none;
        font-size: 1.3rem;
        font-weight: 700;
        color: #ffffff;
      }

      .logo:hover {
        transform: scale(1.1);
      }

      .logo .mind {
        color: #ff6600;
      }

      /* Main Container */
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 80px 20px 40px;
        min-height: 100vh;
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 40px;
        text-align: center;
      }

      .accent {
        color: #ff6600;
      }

      /* Form Section */
      .form-section {
        background-color: #1a1a1a;
        padding: 40px;
        border-radius: 24px;
        
        margin-bottom: 40px;
      }

      .form-group {
        margin-bottom: 24px;
        position: relative;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #ff6600;
      }

      textarea {
        width: 100%;
        padding: 20px;
        background-color: #0a0a0a;
        border: 1px solid #333333;
        border-radius: 24px;
        color: #ffffff;
        font-family: inherit;
        font-size: 1rem;
        transition: border-color 0.3s ease;
        resize: none;
        min-height: 120px;
        overflow: hidden;
      }

      textarea:focus {
        outline: none;
        border-color: #ff6600;
      }

      .attachment-container {
        display: flex;
        gap: 12px;
        margin-top: 12px;
        flex-wrap: wrap;
      }

      .attach-btn {
        width: 48px;
        height: 48px;
        background-color: #ff6600;
        color: #000000;
        border: none;
        border-radius: 50%;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .attach-btn:hover {
        background-color: #ff8533;
        transform: scale(1.1);
        box-shadow: 0 8px 16px rgba(255, 102, 0, 0.3);
      }

      #photo-input,
      #video-input {
        display: none;
      }

      .media-item {
        position: relative;
        display: inline-block;
      }

      .media-preview {
        max-width: 100px;
        max-height: 100px;
        border-radius: 8px;
        object-fit: cover;
        border: 2px solid #ff6600;
      }

      .remove-media {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: #ff6600;
        color: #000000;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .remove-media:hover {
        background-color: #ff8533;
      }

      /* Popup Modal */
      .popup-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: transparent;
        z-index: 1999;
      }

      .popup-overlay.active {
        display: block;
      }

      .attachment-popup {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 8px;
        background-color: #1a1a1a;
        border: 2px solid #ff6600;
        border-radius: 12px;
        padding: 12px;
        z-index: 2000;
        min-width: 160px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.8);
      }

      .attachment-popup.active {
        display: block;
      }

      .popup-title {
        display: none;
      }

      .popup-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .popup-btn {
        padding: 10px 16px;
        background-color: #ff6600;
        color: #000000;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 8px;
      }

      .popup-btn:hover {
        background-color: #ff8533;
        transform: translateX(4px);
      }

      .popup-btn:active {
        transform: translateX(0);
      }

      .popup-close {
        display: none;
      }

      .attach-btn-wrapper {
        position: relative;
        display: inline-block;
      }

      .button {
        display: inline-block;
        padding: 12px 32px;
        background-color: #ff6600;
        color: #000000;
        border: none;
        border-radius: 24px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 12px;
      }

      .button:hover {
        background-color: #ff8533;
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(255, 102, 0, 0.3);
      }

      .button:active {
        transform: translateY(0);
      }

      .button:disabled {
        background-color: #666666;
        cursor: not-allowed;
        transform: none;
      }

      /* Result Section */
      .result-section {
        background-color: #1a1a1a;
        padding: 40px;
        border-radius: 24px;
        
        margin-bottom: 40px;
        display: none;
      }

      .result-section.active {
        display: block;
      }

      .result-category {
        font-size: 1.5rem;
        color: #ff6600;
        margin-bottom: 16px;
        font-weight: 600;
      }

      .result-description {
        color: #cccccc;
        margin-bottom: 24px;
        line-height: 1.8;
        padding: 20px;
        background-color: #0a0a0a;
        border-radius: 24px;
        border: 1px solid #333333;
      }

      .feedback-buttons {
        display: flex;
        gap: 12px;
        margin-top: 24px;
      }

      .feedback-buttons button {
        flex: 1;
        border-radius: 24px;
      }

      /* Error Message */
      .error-message {
        background-color: #331a1a;
        color: #ff9999;
        padding: 16px;
        border-radius: 24px;
        
        margin-bottom: 24px;
        display: none;
      }

      .error-message.active {
        display: block;
      }

      /* Loading State */
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #666666;
        border-top: 3px solid #ff6600;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Stats Section */
      .stats-section {
        background-color: #1a1a1a;
        padding: 40px;
        border-radius: 24px;
        margin-bottom: 40px;
        text-align: center;
        display: none;
      }

      .stats-section.active {
        display: block;
      }

      .stats-section h2 {
        font-size: 1.5rem;
        margin-bottom: 24px;
        color: #ff6600;
      }

      .stat-item {
        display: inline-block;
        margin: 0 24px;
      }

      .stat-number {
        font-size: 2rem;
        color: #ff6600;
        font-weight: 700;
      }

      .stat-label {
        color: #cccccc;
        margin-top: 8px;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .container {
          padding: 60px 16px 24px;
        }

        h1 {
          font-size: 1.8rem;
        }

        .form-section,
        .result-section,
        .stats-section {
          padding: 24px;
        }

        .feedback-buttons {
          flex-direction: column;
        }

        .stat-item {
          display: block;
          margin: 16px 0;
        }
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="/" class="logo">
        Civic<span class="mind">Mind</span>
      </a>
    </nav>

    <div class="container">
      <h1>Report Your <span class="accent">Concern</span></h1>

      <div class="error-message" id="error"></div>

      <div class="form-section">
        <div class="form-group">
          <label for="complaint-text">Describe Your Issue:</label>
          <textarea
            id="complaint-text"
            placeholder="Tell us about the issue you're experiencing..."
          ></textarea>
          <div class="attachment-container">
            <div class="attach-btn-wrapper">
              <button type="button" class="attach-btn" id="attach-btn" title="Attach photos or videos">+</button>
              <!-- Attachment Popup -->
              <div class="attachment-popup" id="attachment-popup">
                <div class="popup-options">
                  <button class="popup-btn" id="photo-btn">ðŸ“· Photo</button>
                  <button class="popup-btn" id="video-btn">ðŸŽ¥ Video</button>
                </div>
              </div>
            </div>
            <input type="file" id="photo-input" accept="image/*" multiple />
            <input type="file" id="video-input" accept="video/*" multiple />
            <div id="media-container"></div>
          </div>
        </div>

        <button class="button" id="analyze-btn">Analyze Issue</button>
      </div>

      <!-- Popup Overlay -->
      <div class="popup-overlay" id="popup-overlay"></div>

      <div class="result-section" id="result-section">
        <div class="result-category" id="result-category">Category</div>
        <div class="result-description" id="result-description">
          Description of the issue...
        </div>

        <div class="feedback-buttons">
          <button class="button" id="satisfied-btn">Satisfied</button>
          <button class="button" id="unsatisfied-btn">Not Satisfied</button>
        </div>
      </div>

      <div class="stats-section" id="stats-section">
        <h2>Community Impact</h2>
        <div class="stat-item">
          <div class="stat-number" id="total-reports">0</div>
          <div class="stat-label">Total Reports</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="avg-satisfaction">0%</div>
          <div class="stat-label">Satisfaction Rate</div>
        </div>
      </div>
    </div>

    <script>
      const attachBtn = document.getElementById("attach-btn");
      const photoInput = document.getElementById("photo-input");
      const videoInput = document.getElementById("video-input");
      const mediaContainer = document.getElementById("media-container");
      const attachmentPopup = document.getElementById("attachment-popup");
      const popupOverlay = document.getElementById("popup-overlay");
      const photoBtn = document.getElementById("photo-btn");
      const videoBtn = document.getElementById("video-btn");
      let attachedMedia = [];

      // Popup handlers
      attachBtn.addEventListener("click", () => {
        attachmentPopup.classList.add("active");
        popupOverlay.classList.add("active");
      });

      popupClose.addEventListener("click", closePopup);
      popupOverlay.addEventListener("click", closePopup);

      function closePopup() {
        attachmentPopup.classList.remove("active");
        popupOverlay.classList.remove("active");
      }

      photoBtn.addEventListener("click", () => {
        closePopup();
        photoInput.click();
      });

      videoBtn.addEventListener("click", () => {
        closePopup();
        videoInput.click();
      });

      // Handle photo selection
      photoInput.addEventListener("change", (e) => {
        handleFileSelection(e);
        photoInput.value = "";
      });

      // Handle video selection
      videoInput.addEventListener("change", (e) => {
        handleFileSelection(e);
        videoInput.value = "";
      });

      function handleFileSelection(e) {
        const files = e.target.files;
        for (let file of files) {
          if (file.type.startsWith("image/") || file.type.startsWith("video/")) {
            const reader = new FileReader();
            reader.onloadend = () => {
              attachedMedia.push({ file, preview: reader.result });
              displayMedia();
            };
            reader.readAsDataURL(file);
          }
        }
      }

      function displayMedia() {
        mediaContainer.innerHTML = "";
        attachedMedia.forEach((media, index) => {
          const div = document.createElement("div");
          div.className = "media-item";
          
          const isVideo = media.file.type.startsWith("video/");
          const element = isVideo
            ? `<video class="media-preview" src="${media.preview}" controls></video>`
            : `<img class="media-preview" src="${media.preview}" alt="Attached media" />`;
          
          div.innerHTML =
            element +
            `<button type="button" class="remove-media" data-index="${index}">Ã—</button>`;
          
          mediaContainer.appendChild(div);
        });

        // Add remove handlers
        document.querySelectorAll(".remove-media").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const index = parseInt(e.target.dataset.index);
            attachedMedia.splice(index, 1);
            displayMedia();
          });
        });
      }

      // Analyze complaint
      analyzeBtn.addEventListener("click", async () => {
        const text = complaintTextArea.value.trim();
        
        if (!text && attachedMedia.length === 0) {
          showError("Please enter a complaint or attach media");
          return;
        }

        analyzeBtn.disabled = true;
        errorMessage.classList.remove("active");

        try {
          analyzeBtn.innerHTML =
            '<span class="loading"></span>Analyzing...';

          // Prepare FormData with text and attached media
          const formData = new FormData();
          formData.append("text", text);
          
          attachedMedia.forEach((media, index) => {
            formData.append("media", media.file);
          });

          // Call backend API
          const response = await fetch("http://localhost:5173/analyze", {
            method: "POST",
            body: formData
          });

          const data = await response.json();

          if (!response.ok) {
            showError(data.error || "Failed to analyze complaint");
            analyzeBtn.innerHTML = "Analyze Issue";
            analyzeBtn.disabled = false;
            return;
          }

          // Display result in same format as page
          resultCategory.textContent = data.category || "Issue Category";
          resultDescription.textContent = data.description || "Analysis description";
          resultSection.classList.add("active");

          analyzeBtn.innerHTML = "Analyze Issue";
        } catch (err) {
          showError("Failed to connect to server. Please try again.");
          console.error(err);
          analyzeBtn.innerHTML = "Analyze Issue";
        } finally {
          analyzeBtn.disabled = false;
        }
      });

      // Handle feedback
      satisfiedBtn.addEventListener("click", () => {
        submitFeedback(true);
      });

      unsatisfiedBtn.addEventListener("click", () => {
        submitFeedback(false);
      });

      function submitFeedback(satisfied) {
        try {
          // Send feedback to backend
          fetch("http://localhost:5173/feedback", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              text: complaintTextArea.value,
              category: resultCategory.textContent,
              satisfied: satisfied
            })
          }).catch(err => console.error(err));

          // Show stats
          statsSection.classList.add("active");
          document.getElementById("total-reports").textContent = 
            Math.floor(Math.random() * 500) + 50;
          document.getElementById("avg-satisfaction").textContent = 
            Math.floor(Math.random() * 30) + 70 + "%";

          resultSection.classList.remove("active");
          complaintTextArea.value = "";
          attachedMedia = [];
          displayMedia();

          setTimeout(() => {
            statsSection.classList.remove("active");
          }, 3000);
        } catch (err) {
          showError("Failed to submit feedback. Please try again.");
          console.error(err);
        }
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add("active");
      }
    </script>
  </body>
</html>
