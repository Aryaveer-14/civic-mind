<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CivicMind - Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif; background-color: #000; color: #fff; line-height: 1.6; }
      nav { position: fixed; top: 0; left: 0; right: 0; padding: 24px 32px; z-index: 1000; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); }
      .logo { display:flex; align-items:center; justify-content:center; font-size:1.3rem; font-weight:700; color:#fff; text-decoration:none; }
      .logo .mind { color: #ff6600; }
      .nav-links { display: flex; gap: 24px; align-items: center; }
      .nav-link { color: #fff; text-decoration: none; font-weight: 500; transition: color 0.3s; }
      .nav-link:hover { color: #ff6600; }
      .user-icon { width:48px; height:48px; background:#ff6600; border:none; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:24px; color:#000; }
      .container { max-width: 1200px; margin: 0 auto; padding: 100px 20px 40px; min-height: 100vh; }
      h1 { font-size: 2.5rem; margin-bottom: 20px; }
      .accent { color:#ff6600; }
      .subtitle { color: #999; font-size: 1.1rem; margin-bottom: 40px; }
      .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
      .stat-card { background: #1a1a1a; padding: 30px; border-radius: 16px; text-align: center; border: 1px solid #333; }
      .stat-number { font-size: 2.5rem; color: #ff6600; font-weight: 700; }
      .stat-label { color: #999; margin-top: 8px; font-size: 0.9rem; }
      .section { background: #1a1a1a; padding: 40px; border-radius: 24px; margin-bottom: 40px; border: 1px solid #333; }
      .section-title { font-size: 1.8rem; margin-bottom: 30px; color: #ff6600; }
      .complaint-card { background: #0a0a0a; padding: 24px; border-radius: 16px; margin-bottom: 20px; border-left: 4px solid #ff6600; }
      .complaint-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; }
      .complaint-title { font-size: 1.2rem; color: #fff; font-weight: 600; }
      .complaint-date { color: #999; font-size: 0.85rem; }
      .complaint-info { margin-bottom: 12px; }
      .complaint-label { color: #ff6600; font-weight: 600; display: inline-block; width: 120px; }
      .complaint-value { color: #ccc; }
      .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
      .badge-high { background: #ff3333; color: #fff; }
      .badge-medium { background: #ff6600; color: #000; }
      .badge-low { background: #666; color: #fff; }
      .empty-state { text-align: center; padding: 60px 20px; color: #666; }
      .empty-icon { font-size: 4rem; margin-bottom: 20px; }
      .button { display: inline-block; padding: 12px 32px; background: #ff6600; color: #000; border: none; border-radius: 24px; font-weight: 600; cursor: pointer; text-decoration: none; }
      .button:hover { background: #ff8533; }
      .loading { text-align: center; padding: 40px; color: #ff6600; }
    </style>
  </head>
  <body>
    <nav>
      <a href="/" class="logo">Civic<span class="mind">Mind</span></a>
      <div class="nav-links">
        <a href="working.html" class="nav-link">Report Issue</a>
        <a href="dashboard.html" class="nav-link">Dashboard</a>
        <button class="user-icon" onclick="logout()" title="Logout">ðŸ‘¤</button>
      </div>
    </nav>

    <div class="container">
      <h1>My <span class="accent">Dashboard</span></h1>
      <p class="subtitle" id="user-welcome">Welcome back!</p>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="total-complaints">0</div>
          <div class="stat-label">Total Reports</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="pending-complaints">0</div>
          <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="resolved-complaints">0</div>
          <div class="stat-label">Resolved</div>
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">ðŸ“‹ My Past Complaints</h2>
        <div id="complaints-loading" class="loading">Loading your complaints...</div>
        <div id="complaints-list"></div>
        <div id="complaints-empty" class="empty-state" style="display: none;">
          <div class="empty-icon">ðŸ“­</div>
          <h3>No complaints yet</h3>
          <p style="margin-top: 12px; margin-bottom: 24px;">Start making a difference by reporting your first issue!</p>
          <a href="working.html" class="button">Report an Issue</a>
        </div>
      </div>
    </div>

    <script>
      // Check if user is logged in
      const userId = localStorage.getItem("user_id");
      const userName = localStorage.getItem("user_name");
      const userEmail = localStorage.getItem("user_email");

      if (!userId && !userName) {
        window.location.href = "auth.html";
      }

      // Update welcome message
      document.getElementById("user-welcome").textContent = `Welcome back, ${userName || "User"}!`;

      function logout() {
        localStorage.removeItem("user_id");
        localStorage.removeItem("user_name");
        localStorage.removeItem("user_email");
        localStorage.removeItem("user_token");
        localStorage.removeItem("user_locality");
        window.location.href = "auth.html";
      }

      // Fetch user complaints
      async function loadComplaints() {
        const loadingEl = document.getElementById("complaints-loading");
        const listEl = document.getElementById("complaints-list");
        const emptyEl = document.getElementById("complaints-empty");

        try {
          const backendHost = (window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost") ? window.location.hostname : "localhost";
          const API_BASE = `http://${backendHost}:5000`;
          
          const response = await fetch(`${API_BASE}/user/${userId}/complaints`);
          const data = await response.json();

          loadingEl.style.display = "none";

          if (!data.success || !data.complaints || data.complaints.length === 0) {
            emptyEl.style.display = "block";
            return;
          }

          // Update stats
          document.getElementById("total-complaints").textContent = data.total || 0;
          document.getElementById("pending-complaints").textContent = data.total || 0;
          document.getElementById("resolved-complaints").textContent = "0";

          // Render complaints
          listEl.innerHTML = data.complaints.map(complaint => {
            const date = new Date(complaint.created_at).toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'short', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            
            const priority = complaint.ai_decision?.priority || "Medium";
            const badgeClass = priority === "High" ? "badge-high" : priority === "Low" ? "badge-low" : "badge-medium";

            return `
              <div class="complaint-card">
                <div class="complaint-header">
                  <div class="complaint-title">${complaint.ai_decision?.problem || "Issue Report"}</div>
                  <span class="badge ${badgeClass}">${priority}</span>
                </div>
                <div class="complaint-info">
                  <span class="complaint-label">Area:</span>
                  <span class="complaint-value">${complaint.ai_decision?.area || "-"}</span>
                </div>
                <div class="complaint-info">
                  <span class="complaint-label">Authority:</span>
                  <span class="complaint-value">${complaint.ai_decision?.concerned_authority || "-"}</span>
                </div>
                <div class="complaint-info">
                  <span class="complaint-label">Solution:</span>
                  <span class="complaint-value">${complaint.ai_decision?.solution || "-"}</span>
                </div>
                <div class="complaint-info">
                  <span class="complaint-label">Contact:</span>
                  <span class="complaint-value">${complaint.ai_decision?.contact_information || "-"}</span>
                </div>
                <div class="complaint-date" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #333;">
                  ðŸ“… Reported on ${date}
                </div>
              </div>
            `;
          }).join('');

        } catch (err) {
          console.error("Failed to load complaints:", err);
          loadingEl.innerHTML = '<p style="color: #ff9999;">Failed to load complaints. Please try again.</p>';
        }
      }

      // Load complaints on page load
      window.addEventListener("load", loadComplaints);
    </script>
  </body>
</html>
